<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Feedback Contratos</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container mt-5">
    <div id="relatorios-wrapper">
        <div class="relatorio">
            <form method="post" enctype="multipart/form-data" class="form-container">
                <img src="{{ url_for('static', filename='topo.png') }}" class="top-image">

                <!-- SE√á√ÉO 1 -->
                <div class="section-title">1. Informa√ß√µes do Contrato</div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Contrato:</label>
                        <select name="CONTRATO" class="form-select" onchange="location.href='/?contrato='+this.value">
                            <option value="">-- Selecione --</option>
                            {% for c in contratos %}
                                <option value="{{ c }}" {% if dados.CONTRATO == c %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">N¬∫ Contrato:</label>
                        <input type="text" name="N¬∫ CONTRATO" class="form-control" value="{{ dados['N¬∫ CONTRATO']|default('') }}">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Empresa:</label>
                        <input type="text" name="EMPRESA" class="form-control" value="{{ dados['EMPRESA']|default('') }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Estado:</label>
                        <input type="text" name="ESTADO" class="form-control" value="{{ dados['ESTADO']|default('') }}">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Prazo Final Contratual:</label>
                        <input type="date" name="PRAZO FINAL CONTRATUAL" class="form-control" value="{{ dados['PRAZO FINAL CONTRATUAL']|default('') }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Data Relat√≥rio:</label>
                        <input type="date" name="DATA RELAT√ìRIO" class="form-control">
                    </div>
                </div>

                <!-- SE√á√ÉO 2 -->
                <div class="section-title" onclick="toggleValores()" style="cursor:pointer;">2. Valores do Contrato <span id="toggle-icon">[-]</span></div>
                <div id="valores-section" class="row mb-4 d-flex flex-wrap oculto" style="gap: 1rem;">
                    {% for campo in ['VALOR DO CONTRATO', 'VALOR ADITIVO', 'VALOR CONTRATO + ADITIVOS', 'VALOR CONSUMIDO', 'SALDO DO CONTRATO PERCENTUAL', 'SALDO DO CONTRATO'] %}
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ campo }}:</label>
                        <input type="text" name="{{ campo }}" class="form-control">
                    </div>
                    {% endfor %}
                </div>

                <!-- SE√á√ÉO 3 -->
                <div class="section-title">3. Informa√ß√µes Complementares</div>
                <div class="mb-3">
                    <label class="form-label">Medi√ß√£o em andamento, para emitir NF?</label>
                    <textarea name="MEDI√á√ÉO EM ANDAMENTO, PARA EMITIR NF?" class="form-control auto-expand" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">NF em aberto, qual a previs√£o de pagamento?</label>
                    <textarea name="NF EM ABERTO, QUAL A PREVIS√ÉO DE PAGAMENTO?" class="form-control auto-expand" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Aditivo, adequa√ß√£o, notifica√ß√£o ou comunica√ß√£o diversos?</label>
                    <textarea name="ADITIVO, ADEQUA√á√ÉO, NOTIFICA√á√ÉO OU COMUNICA√á√ÉO DIVERSOS?" class="form-control auto-expand" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Respons√°vel pelo relat√≥rio:</label>
                    <select name="RESPONS√ÅVEL PELO RELAT√ìRIO" class="form-select">
                        <option value="">-- Selecione --</option>
                        <option>Everton Oliveira</option>
                        <option>Mathews Mayckell Pinheiro de Assis Vasconcelos</option>
                        <option>Mar√≠lia Bezerril Gomes</option>
                        <option>Vilmar William Ferreira</option>
                        <option>Ros√¢ngela Jales</option>
                        <option>Tiago Jose Erhart</option>
                    </select>
                </div>


                <!-- SE√á√ÉO 4 -->
                <div class="section-title">4. Anexar Imagens ao Relat√≥rio</div>
                <div class="mb-3">
                    <div class="imagens-container">
                        <input type="file" name="IMAGENS" class="form-control mb-2 no-print" onchange="previewImage(this)">
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2 no-print" onclick="adicionarCampoImagem(this)">+ Adicionar outra imagem</button>
                </div>
                <div class="preview-area mt-4"></div>
            </form>
        </div>
    </div>

    <!-- BOT√ïES -->
    <div class="text-center mt-4 no-print">
        <button class="btn btn-primary" onclick="adicionarRelatorio()">+ Adicionar Outro Relat√≥rio</button>
        <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Imprimir ou Salvar PDF</button>
    </div>
</div>


<script>
function autoResizeTextareas(context = document) {
    context.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
}

function adicionarCampoImagem(botao) {
    const container = botao.parentElement.querySelector('.imagens-container');
    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'IMAGENS';
    input.className = 'form-control mb-2';
    input.onchange = function () { previewImage(this); };
    container.appendChild(input);
}

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper mb-3';

            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image w-100';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-danger btn-sm mt-2';
            btn.innerText = 'Remover imagem';
            btn.onclick = () => wrapper.remove();

            wrapper.appendChild(img);
            wrapper.appendChild(btn);

            const previewArea = input.closest('.relatorio').querySelector('.preview-area');
            previewArea.appendChild(wrapper);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function adicionarRelatorio() {
    const wrapper = document.getElementById('relatorios-wrapper');
    const original = wrapper.querySelector('.relatorio');
    const clone = original.cloneNode(true);

    // limpa campos
    clone.querySelectorAll('input, textarea, select').forEach(el => {
        if (el.type !== 'file') el.value = '';
    });

    // limpa imagens
    clone.querySelector('.preview-area').innerHTML = '';

    // reconecta onchange imagem
    clone.querySelectorAll('input[type="file"]').forEach(input => {
        input.onchange = function () { previewImage(this); };
    });

    wrapper.appendChild(clone);

    // ativa auto-expans√£o nos novos textareas
    autoResizeTextareas(clone);
}

// inicializa expans√£o autom√°tica no carregamento
autoResizeTextareas();

document.querySelectorAll('textarea').forEach(textarea => {
    textarea.setAttribute("style", "height:" + (textarea.scrollHeight) + "px;overflow-y:hidden;");
    textarea.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    });
});

// Ajuste autom√°tico da altura da imagem baseado no espa√ßo dispon√≠vel
window.addEventListener('beforeprint', () => {
    document.querySelectorAll('.preview-image').forEach(img => {
        const offsetTop = img.getBoundingClientRect().top;
        const spaceLeft = window.innerHeight - offsetTop - 60;
        img.style.maxHeight = spaceLeft + 'px';
    });
});

document.addEventListener("DOMContentLoaded", () => {
    const toggleSection2 = document.querySelector('.section-title:nth-of-type(2)');
    const valoresSection = toggleSection2.nextElementSibling;

    toggleSection2.style.cursor = 'pointer';
    toggleSection2.addEventListener('click', () => {
        valoresSection.style.display = valoresSection.style.display === 'none' ? 'flex' : 'none';
    });
});


function toggleValores() {
    const valores = document.getElementById('valores-section');
    const icon = document.getElementById('toggle-icon');

    if (valores.classList.contains('oculto')) {
        valores.classList.remove('oculto');
        icon.innerText = '[-]';
    } else {
        valores.classList.add('oculto');
        icon.innerText = '[+]';
    }
}

</script>
<footer class="no-print rodape-contrato">
    <p>Setor de Contratos ¬∑ GENPAC<br>By Vilmar William Ferreira ¬∑ Todos os direitos reservados</p>
</footer>

</body>
</html>
